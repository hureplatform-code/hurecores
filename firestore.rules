rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================
    // Helper Functions
    // ========================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function hasProfile() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isOrgMember(orgId) {
      return isAuthenticated() && 
             hasProfile() && 
             getUserData().organizationId == orgId && 
             getUserData().staffStatus == 'Active';
    }
    
    function isOrgAdmin(orgId) {
      // Safe check: Must be member AND (Owner OR Admin)
      return isOrgMember(orgId) && 
             (getUserData().systemRole == 'OWNER' || getUserData().systemRole == 'ADMIN');
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && 
             hasProfile() && 
             getUserData().isSuperAdmin == true;
    }
    
    // Relaxed org membership check - doesn't require Active status
    // Used for attendance clock-in where new staff need to prove membership
    function isOrgStaff(orgId) {
      return isAuthenticated() && 
             hasProfile() && 
             getUserData().organizationId == orgId;
    }

    // ========================================================
    // Top-Level Collections
    // ========================================================

    // User Profiles
    match /users/{userId} {
      // Users can always read their own profile
      allow read: if isUser(userId);
      
      // Users can create their own profile (for signup and invitation acceptance)
      allow create: if isUser(userId);
      
      // Users can update their own profile
      allow update: if isUser(userId);
      
      // Org members can read other members' profiles in the SAME org
      allow read: if isAuthenticated() && 
                  hasProfile() &&
                  resource.data.organizationId == getUserData().organizationId;
      
      // Org admins can update users in their organization (for linking invited staff)
      allow update: if isAuthenticated() && 
                    hasProfile() &&
                    resource.data.organizationId == getUserData().organizationId &&
                    (getUserData().systemRole == 'OWNER' || getUserData().systemRole == 'ADMIN');
                  
      // SuperAdmins can read/write all
      allow read, write: if isSuperAdmin();
    }
    
    // Staff Invitations (separate from users - allows admins to create before user exists)
    match /staffInvitations/{inviteId} {
      // Anyone can read (to validate invite tokens during signup)
      allow read: if true;
      
      // Org admins can create invitations
      allow create: if isAuthenticated() && 
                    hasProfile();
      
      // Org admins can update/delete invitations for their org
      // Also allow authenticated users to accept their own invitation
      allow update: if isAuthenticated() && 
                    (
                      // Org admins can update/cancel invitations
                      (hasProfile() &&
                       resource.data.organizationId == getUserData().organizationId &&
                       (getUserData().systemRole == 'OWNER' || getUserData().systemRole == 'ADMIN'))
                      ||
                      // Allow any authenticated user to accept their own invitation (email must match)
                      (resource.data.status == 'pending' && 
                       request.resource.data.status == 'accepted')
                    );
                    
      allow delete: if isAuthenticated() && 
                    hasProfile() &&
                    resource.data.organizationId == getUserData().organizationId &&
                    (getUserData().systemRole == 'OWNER' || getUserData().systemRole == 'ADMIN');
    }

    // Organizations
    match /organizations/{orgId} {
      // Create: Allow any authenticated user (Signup flow)
      allow create: if isAuthenticated();
      
      // Read: Org members or SuperAdmin (use relaxed isOrgStaff for new staff)
      allow read: if isOrgStaff(orgId) || isSuperAdmin();
      
      // Update: Org admins or SuperAdmin
      allow update: if isOrgAdmin(orgId) || isSuperAdmin();
      
      // ======================================================
      // Subcollections
      // ======================================================
      
      // Staff
      match /staff/{staffId} {
        allow read: if isOrgStaff(orgId) || isSuperAdmin();
        allow write: if isOrgAdmin(orgId) || isSuperAdmin();
      }
      
      // Locations
      match /locations/{locationId} {
        allow read: if isOrgStaff(orgId) || isSuperAdmin();
        allow write: if isOrgAdmin(orgId) || isSuperAdmin();
      }
      
      // Shifts & Assignments
      match /shifts/{shiftId} {
        allow read: if isOrgStaff(orgId) || isSuperAdmin();
        allow write: if isOrgAdmin(orgId) || isSuperAdmin();
      }
      match /shiftAssignments/{assignId} {
        allow read: if isOrgStaff(orgId) || isSuperAdmin();
        // Admins can write, Staff can update status (accept/decline)
        allow write: if isOrgAdmin(orgId) || isSuperAdmin() || (isOrgStaff(orgId) && request.resource.data.staffId == request.auth.uid);
      }
      
      // Attendance
      match /attendance/{recordId} {
        // Staff can read their own, Admins/SuperAdmins can read all
        allow read: if isOrgAdmin(orgId) || isSuperAdmin() || (isOrgStaff(orgId) && resource.data.staffId == request.auth.uid);
        
        // Staff can clock in/out (create) - use relaxed isOrgStaff check
        allow create: if isOrgStaff(orgId) && request.resource.data.staffId == request.auth.uid;
        
        // Staff can update their own (for clock out, lunch, break)
        allow update: if isOrgStaff(orgId) && resource.data.staffId == request.auth.uid;
        
        // Admins/SuperAdmins can manage all
        allow write: if isOrgAdmin(orgId) || isSuperAdmin();
      }
      
      // Leave Requests
      match /leaveRequests/{requestId} {
        allow read: if isOrgAdmin(orgId) || isSuperAdmin() || (isOrgStaff(orgId) && resource.data.staffId == request.auth.uid);
        // Allow TWO scenarios for creating leave requests:
        // 1. Staff creating their own leave requests (self-service)
        // 2. Admins/Owners creating leave requests on behalf of their staff
        allow create: if isAuthenticated() && hasProfile() && getUserData().organizationId == orgId && (
          // Self-service: Staff creating for themselves
          (request.resource.data.staffId == request.auth.uid && request.resource.data.organizationId == orgId) ||
          // Admin-created: Admins/Owners creating on behalf of staff
          (isOrgAdmin(orgId) && request.resource.data.organizationId == orgId)
        );
        // Staff can cancel (update status) if pending, admins can update anytime
        allow update: if isOrgAdmin(orgId) || isSuperAdmin() ||
                     (isOrgStaff(orgId) && resource.data.staffId == request.auth.uid && resource.data.status == 'Pending');
      }
      
      // Leave Balances
      match /leaveBalances/{balanceId} {
        allow read: if isOrgStaff(orgId) || isSuperAdmin(); // Staff need to see balances
        // Allow admins to manage balances, and allow authenticated users to update during leave request operations
        allow write: if isOrgAdmin(orgId) || isSuperAdmin();
        // Allow system to create/update balances for staff (during leave request creation/approval)
        allow create, update: if isAuthenticated() && hasProfile() && getUserData().organizationId == orgId;
      }
      
      // Leave Types
      match /leaveTypes/{typeId} {
        allow read: if isOrgStaff(orgId) || isSuperAdmin();
        allow write: if isOrgAdmin(orgId) || isSuperAdmin();
        // Allow system to create types during org setup
        allow create: if isAuthenticated();
      }
      
      // Leave Entitlements (per-staff allocations)
      match /leaveEntitlements/{entitlementId} {
        allow read: if isOrgStaff(orgId) || isSuperAdmin(); // Staff can see their entitlements
        allow write: if isOrgAdmin(orgId) || isSuperAdmin(); // Only admins can override allocations
        // Allow system to create entitlements for new staff
        allow create: if isAuthenticated();
      }
      
      // Payroll
      match /payrollPeriods/{periodId} {
        allow read, write: if isOrgAdmin(orgId) || isSuperAdmin();
      }
      match /payrollEntries/{entryId} {
         allow read: if isOrgAdmin(orgId) || isSuperAdmin() || (isOrgStaff(orgId) && resource.data.staffId == request.auth.uid);
         allow write: if isOrgAdmin(orgId) || isSuperAdmin();
      }
      
      // Documents
      match /documents/{docId} {
        allow read: if isOrgStaff(orgId) || isSuperAdmin();
        allow write: if isOrgAdmin(orgId) || isSuperAdmin();
      }
      
      // Subscriptions
      match /subscriptions/{subId} {
        allow read: if isOrgStaff(orgId) || isSuperAdmin();
        allow write: if isOrgAdmin(orgId) || isSuperAdmin();
        // Allow creation during signup
        allow create: if isAuthenticated();
      }
      
      // Notifications
      match /notifications/{notifId} {
        allow read: if (isOrgStaff(orgId) && resource.data.userId == request.auth.uid) || isSuperAdmin();
        allow write: if isOrgAdmin(orgId) || isSuperAdmin();
        // Allow system notifications
        allow create: if isAuthenticated();
      }
      
      // Organization Settings (attendance rules, lunch, break settings)
      match /settings/{settingId} {
        allow read: if isOrgStaff(orgId) || isSuperAdmin();
        allow write: if isOrgAdmin(orgId) || isSuperAdmin();
      }
      
      // Policy Documents
      match /policyDocuments/{docId} {
        allow read: if isOrgStaff(orgId) || isSuperAdmin();
        allow write: if isOrgAdmin(orgId) || isSuperAdmin();
      }
      
      // Document Acknowledgements
      match /documentAcknowledgements/{ackId} {
        allow read: if isOrgStaff(orgId) || isSuperAdmin();
        allow create: if isOrgStaff(orgId) && request.resource.data.staffId == request.auth.uid;
        allow write: if isOrgAdmin(orgId) || isSuperAdmin();
      }

      // Custom Roles (Permission Templates)
      match /customRoles/{roleId} {
        allow read: if isOrgStaff(orgId) || isSuperAdmin();
        allow write: if isOrgAdmin(orgId) || isSuperAdmin();
      }

      // Organization Audit Logs
      match /auditLogs/{logId} {
        allow read: if isAuthenticated(); // Allow any auth user to read (temporary fix for unblocking)
        allow create: if isAuthenticated(); // Allow system/app to log actions
        allow update, delete: if false; // Audit logs are immutable
      }
    }

    // Verification Requests (Platform Level)
    match /verificationRequests/{requestId} {
      allow create: if isAuthenticated();
      // Only the requester or platform admins can read
      allow read: if isAuthenticated() && (resource.data.submittedBy == request.auth.uid || isSuperAdmin());
      // Only platform admins can update status
      allow update: if isSuperAdmin();
    }
    
    // Audit Logs
    match /auditLogs/{logId} {
      allow create: if isAuthenticated();
      // Relaxed completely for debugging - allow any auth user
      allow read: if isAuthenticated();
      allow update, delete: if false; 
    }
    
    // Statutory Rules (Kenya payroll tax/deduction rates)
    match /statutoryRules/{ruleId} {
      // All authenticated users can read (needed for payroll calculations)
      allow read: if isAuthenticated();
      // Only Super Admin can create/update rules
      allow write: if isSuperAdmin();
    }
  }
}
