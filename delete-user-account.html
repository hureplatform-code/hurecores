<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delete User Account - HureCore</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a2e35 0%, #0f1a1f 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        h1 {
            color: #ef4444;
            font-size: 24px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .subtitle {
            color: #94a3b8;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .warning-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 25px;
            color: #fca5a5;
            font-size: 13px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            color: #cbd5e1;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
        }
        input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 14px;
            transition: all 0.2s;
        }
        input:focus {
            outline: none;
            border-color: #ef4444;
            background: rgba(255, 255, 255, 0.08);
        }
        input::placeholder {
            color: #64748b;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
        }
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #ef4444;
        }
        .checkbox-group label {
            margin-bottom: 0;
            color: #94a3b8;
            font-size: 13px;
        }
        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
        }
        .result.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #6ee7b7;
        }
        .result.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }
        .result.info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #93c5fd;
        }
        .deleted-items {
            margin-top: 10px;
            font-size: 12px;
            color: #94a3b8;
        }
        .deleted-items li {
            margin-left: 20px;
            margin-top: 5px;
        }
        .section-title {
            color: #4fd1c5;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .logged-in-box {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 10px;
            padding: 12px 15px;
            margin-bottom: 20px;
            color: #6ee7b7;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .logout-btn {
            background: transparent;
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #fca5a5;
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
            cursor: pointer;
            width: auto;
        }
        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóëÔ∏è Delete User Account</h1>
        <p class="subtitle">Completely remove a user account for fresh testing</p>
        
        <div class="warning-box">
            ‚ö†Ô∏è <strong>Warning:</strong> This will permanently delete the user from Firebase Authentication, 
            their profile from Firestore, and optionally their organization data. This cannot be undone!
        </div>

        <!-- Admin Login Section -->
        <div id="loginSection">
            <div class="section-title">üîê First, login as Super Admin</div>
            <div class="form-group">
                <label for="adminEmail">Super Admin Email</label>
                <input type="email" id="adminEmail" placeholder="superadmin@example.com" required>
            </div>
            <div class="form-group">
                <label for="adminPassword">Password</label>
                <input type="password" id="adminPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            </div>
            <button id="loginBtn" onclick="loginAdmin()">Login as Admin</button>
        </div>

        <!-- Delete Section (hidden until logged in) -->
        <div id="deleteSection" style="display: none;">
            <div class="logged-in-box">
                ‚úÖ Logged in as: <strong id="loggedInAs"></strong>
                <button class="logout-btn" onclick="logoutAdmin()">Logout</button>
            </div>

            <div class="form-group">
                <label for="email">User Email to Delete</label>
                <input type="email" id="email" placeholder="user@example.com" required>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="deleteOrg" checked>
                <label for="deleteOrg">Also delete their organization and all related data</label>
            </div>

            <button id="deleteBtn" onclick="deleteUser()">Delete Account Completely</button>
        </div>
        
        <div id="result"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB90Dc0mXjktNuHy2qeMsmVszTz_NHai5g",
            authDomain: "hurecore-cd39e.firebaseapp.com",
            projectId: "hurecore-cd39e",
            storageBucket: "hurecore-cd39e.firebasestorage.app",
            messagingSenderId: "435515143399",
            appId: "1:435515143399:web:aab023b0d8bbdabbc01e42",
            measurementId: "G-3K6V9WKLMQ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentAdmin = null;

        // Check if already logged in
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentAdmin = user;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('deleteSection').style.display = 'block';
                document.getElementById('loggedInAs').textContent = user.email;
            } else {
                currentAdmin = null;
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('deleteSection').style.display = 'none';
            }
        });

        async function loginAdmin() {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;
            const resultDiv = document.getElementById('result');
            const btn = document.getElementById('loginBtn');

            if (!email || !password) {
                resultDiv.innerHTML = '<div class="result error">Please enter email and password.</div>';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Logging in...';

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentAdmin = userCredential.user;
                resultDiv.innerHTML = '<div class="result success">‚úÖ Logged in successfully!</div>';
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Login failed: ${error.message}</div>`;
            }

            btn.disabled = false;
            btn.textContent = 'Login as Admin';
        }

        async function logoutAdmin() {
            await auth.signOut();
            document.getElementById('result').innerHTML = '';
        }

        async function deleteUser() {
            const email = document.getElementById('email').value.trim();
            const deleteOrg = document.getElementById('deleteOrg').checked;
            const resultDiv = document.getElementById('result');
            const btn = document.getElementById('deleteBtn');

            if (!email) {
                resultDiv.innerHTML = '<div class="result error">Please enter an email address.</div>';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Deleting...';
            resultDiv.innerHTML = '<div class="result info">üîç Finding user account...</div>';

            const deletedItems = [];

            try {
                // Step 1: Find user profile in Firestore by email
                const usersSnapshot = await db.collection('users')
                    .where('email', '==', email)
                    .get();

                if (usersSnapshot.empty) {
                    resultDiv.innerHTML = '<div class="result error">‚ùå No user found with this email in the database.</div>';
                    btn.disabled = false;
                    btn.textContent = 'Delete Account Completely';
                    return;
                }

                const userDoc = usersSnapshot.docs[0];
                const userData = userDoc.data();
                const userId = userDoc.id;
                const organizationId = userData.organizationId;

                resultDiv.innerHTML = `<div class="result info">üìã Found user: ${userData.fullName || email} (${userId})</div>`;

                // Step 2: Delete organization data if requested
                if (deleteOrg && organizationId) {
                    resultDiv.innerHTML = `<div class="result info">üè¢ Deleting organization data...</div>`;
                    
                    // Delete organization subcollections
                    const subcollections = [
                        'staff', 'locations', 'schedules', 'attendance', 
                        'leave', 'documents', 'payroll', 'subscriptions',
                        'payrollRuns', 'transactions'
                    ];

                    for (const subcoll of subcollections) {
                        try {
                            const snapshot = await db.collection('organizations')
                                .doc(organizationId)
                                .collection(subcoll)
                                .get();
                            
                            if (!snapshot.empty) {
                                const batch = db.batch();
                                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                                await batch.commit();
                                deletedItems.push(`${snapshot.size} ${subcoll} records`);
                            }
                        } catch (e) {
                            console.log(`Subcollection ${subcoll} might not exist:`, e);
                        }
                    }

                    // Delete the organization document itself
                    await db.collection('organizations').doc(organizationId).delete();
                    deletedItems.push('Organization document');
                }

                // Step 3: Delete any staff invitations for this email
                const invitationsSnapshot = await db.collection('staffInvitations')
                    .where('email', '==', email)
                    .get();
                
                if (!invitationsSnapshot.empty) {
                    const batch = db.batch();
                    invitationsSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    deletedItems.push(`${invitationsSnapshot.size} invitation(s)`);
                }

                // Step 4: Delete verification requests
                const verificationsSnapshot = await db.collection('verificationRequests')
                    .where('organizationId', '==', organizationId)
                    .get();
                
                if (!verificationsSnapshot.empty) {
                    const batch = db.batch();
                    verificationsSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    deletedItems.push(`${verificationsSnapshot.size} verification request(s)`);
                }

                // Step 5: Delete audit logs for this user/org
                try {
                    const auditSnapshot = await db.collection('auditLogs')
                        .where('userId', '==', userId)
                        .limit(500)
                        .get();
                    
                    if (!auditSnapshot.empty) {
                        const batch = db.batch();
                        auditSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                        deletedItems.push(`${auditSnapshot.size} audit log(s)`);
                    }
                } catch (e) {
                    console.log('Audit logs cleanup skipped:', e);
                }

                // Step 6: Delete user profile from Firestore
                await db.collection('users').doc(userId).delete();
                deletedItems.push('User profile');

                // Success message
                resultDiv.innerHTML = `
                    <div class="result success">
                        ‚úÖ <strong>Account deleted successfully!</strong>
                        <ul class="deleted-items">
                            ${deletedItems.map(item => `<li>‚úì ${item}</li>`).join('')}
                        </ul>
                        <br>
                        <strong>‚ö†Ô∏è Important:</strong> You still need to delete the user from 
                        <a href="https://console.firebase.google.com/project/hurecore-cd39e/authentication/users" 
                           target="_blank" style="color: #6ee7b7;">Firebase Authentication Console</a> 
                        (search for "${email}" and delete).
                    </div>
                `;

            } catch (error) {
                console.error('Delete error:', error);
                resultDiv.innerHTML = `<div class="result error">‚ùå Error: ${error.message}</div>`;
            }

            btn.disabled = false;
            btn.textContent = 'Delete Account Completely';
        }
    </script>
</body>
</html>
